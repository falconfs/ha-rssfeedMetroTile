<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RSS Feed Metro Tile - Dev Environment</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: var(--dev-bg, #f5f5f5);
        color: var(--dev-text, #333);
        overflow-x: hidden;
      }

      /* =========================
         CSS Variables (Light/Dark)
         ========================= */
      :root {
        --dev-bg: #f5f5f5;
        --dev-text: #333;
        --dev-panel-bg: #ffffff;
        --dev-border: #e0e0e0;
        --dev-input-bg: #ffffff;
        --dev-input-border: #ddd;
        --dev-button-bg: #f5f5f5;
        --dev-button-hover: #e0e0e0;
        --dev-tab-active: #2196f3;
        --dev-shadow: rgba(0, 0, 0, 0.1);

        /* HA Theme Variables (Default Light) */
        --ha-card-background: #ffffff;
        --card-background-color: #ffffff;
        --primary-text-color: #212121;
        --secondary-text-color: #727272;
        --primary-color: #03a9f4;
        --accent-color: #ff9800;
        --secondary-background-color: #f5f5f5;
        --divider-color: rgba(0, 0, 0, 0.12);
        --error-color: #db4437;
        --warning-color: #ffa500;
      }

      body.dark {
        --dev-bg: #1a1a1a;
        --dev-text: #e0e0e0;
        --dev-panel-bg: #2d2d2d;
        --dev-border: #444;
        --dev-input-bg: #1a1a1a;
        --dev-input-border: #444;
        --dev-button-bg: #1a1a1a;
        --dev-button-hover: #333;
        --dev-shadow: rgba(0, 0, 0, 0.3);
      }

      /* =========================
         Header
         ========================= */
      .dev-header {
        background: var(--dev-panel-bg);
        padding: 16px 24px;
        border-bottom: 1px solid var(--dev-border);
        box-shadow: 0 2px 4px var(--dev-shadow);
      }

      .dev-header h1 {
        font-size: 20px;
        margin-bottom: 4px;
        color: var(--dev-text);
      }

      .dev-header p {
        font-size: 13px;
        color: var(--secondary-text-color);
      }

      /* =========================
         Main Layout (Split View)
         ========================= */
      .dev-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        height: calc(100vh - 70px);
        gap: 0;
      }

      /* Left Panel */
      .left-panel {
        background: var(--dev-panel-bg);
        border-right: 1px solid var(--dev-border);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      /* Right Panel */
      .right-panel {
        background: var(--dev-bg);
        overflow-y: auto;
        padding: 20px;
      }

      /* =========================
         Tabs
         ========================= */
      .tabs {
        display: flex;
        border-bottom: 1px solid var(--dev-border);
        background: var(--dev-panel-bg);
      }

      .tab-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--secondary-text-color);
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        background: var(--dev-button-hover);
      }

      .tab-btn.active {
        color: var(--dev-tab-active);
        border-bottom-color: var(--dev-tab-active);
      }

      .tab-content {
        display: none;
        padding: 20px;
        flex: 1;
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }

      /* =========================
         Form Controls
         ========================= */
      .control-section {
        margin-bottom: 24px;
      }

      .control-section h3 {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--secondary-text-color);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--dev-border);
      }

      .control-group {
        margin-bottom: 16px;
      }

      .control-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--dev-text);
        margin-bottom: 6px;
      }

      .control-group label small {
        font-weight: 400;
        color: var(--secondary-text-color);
      }

      .control-group select,
      .control-group input[type='text'],
      .control-group input[type='number'],
      .control-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--dev-input-border);
        border-radius: 4px;
        font-size: 13px;
        background: var(--dev-input-bg);
        color: var(--dev-text);
        font-family: inherit;
      }

      .control-group textarea {
        resize: vertical;
        min-height: 80px;
        font-family: 'Monaco', 'Menlo', monospace;
      }

      .control-group input[type='checkbox'] {
        width: auto;
        margin-right: 8px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .control-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      /* Collapsible Advanced Section */
      .collapsible {
        cursor: pointer;
        user-select: none;
      }

      .collapsible::before {
        content: '‚ñ∂';
        display: inline-block;
        margin-right: 8px;
        transition: transform 0.2s;
      }

      .collapsible.open::before {
        transform: rotate(90deg);
      }

      .collapsible-content {
        display: none;
        padding-top: 12px;
      }

      .collapsible-content.open {
        display: block;
      }

      /* =========================
         YAML Editor
         ========================= */
      .yaml-editor-wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .yaml-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .yaml-actions button {
        padding: 6px 12px;
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        background: var(--dev-button-bg);
        color: var(--dev-text);
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }

      .yaml-actions button:hover {
        background: var(--dev-button-hover);
      }

      #yamlEditor {
        flex: 1;
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        overflow: hidden;
      }

      .yaml-error {
        padding: 12px;
        background: #ffebee;
        border: 1px solid #ef5350;
        border-radius: 4px;
        margin-top: 12px;
        font-size: 12px;
        color: #c62828;
        display: none;
      }

      body.dark .yaml-error {
        background: #3d1a1a;
        border-color: #ef5350;
        color: #ef5350;
      }

      .yaml-error.show {
        display: block;
      }

      /* =========================
         View Mode Selector
         ========================= */
      .view-mode-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      .view-btn {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        background: var(--dev-button-bg);
        color: var(--dev-text);
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      .view-btn:hover {
        background: var(--dev-button-hover);
      }

      .view-btn.active {
        background: var(--dev-tab-active);
        color: white;
        border-color: var(--dev-tab-active);
      }

      /* =========================
         Grid Controls
         ========================= */
      .grid-controls {
        background: var(--dev-panel-bg);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--dev-border);
        margin-bottom: 16px;
      }

      .grid-controls h3 {
        font-size: 14px;
        margin-bottom: 12px;
        color: var(--dev-text);
      }

      .grid-info {
        font-size: 12px;
        color: var(--secondary-text-color);
        margin-top: 8px;
      }

      .grid-info strong {
        color: var(--dev-text);
      }

      /* =========================
         Card Preview Container
         ========================= */
      .preview-container {
        background: var(--dev-panel-bg);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 8px var(--dev-shadow);
      }

      .preview-container h3 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--secondary-text-color);
        margin-bottom: 12px;
      }

      /* Card Wrapper with Grid Sizing */
      .card-wrapper {
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        overflow: hidden;
        transition: all 0.3s;
        /* Default 6x2 grid */
        width: 608px;
        max-width: 100%;
      }

      /* Single View */
      .preview-single {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0;
      }

      /* Compare View */
      .preview-compare {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Grid View (2x2) */
      .preview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .preview-grid .card-wrapper {
        width: 100%;
      }

      /* Hide inactive views */
      .preview-single,
      .preview-compare,
      .preview-grid {
        display: none;
      }

      .preview-single.active,
      .preview-compare.active,
      .preview-grid.active {
        display: grid;
      }

      /* =========================
         Config Status
         ========================= */
      .config-status {
        background: var(--dev-panel-bg);
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--dev-border);
        margin-top: 16px;
        font-size: 12px;
        line-height: 1.6;
      }

      .config-status strong {
        color: var(--dev-text);
      }

      .config-status span {
        color: var(--secondary-text-color);
      }

      /* =========================
         Quick Actions
         ========================= */
      .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 16px;
      }

      .quick-actions button {
        padding: 10px;
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        background: var(--dev-button-bg);
        color: var(--dev-text);
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }

      .quick-actions button:hover {
        background: var(--dev-button-hover);
      }

      /* =========================
         Toast Notifications
         ========================= */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #323232;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 14px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s;
        pointer-events: none;
        z-index: 1000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.success {
        background: #4caf50;
      }

      .toast.error {
        background: #f44336;
      }

      /* =========================
         Mobile Responsive
         ========================= */
      @media (max-width: 768px) {
        .dev-container {
          grid-template-columns: 1fr;
          height: auto;
        }

        .left-panel {
          border-right: none;
          border-bottom: 1px solid var(--dev-border);
          max-height: 60vh;
        }

        .control-row {
          grid-template-columns: 1fr;
        }

        .preview-compare {
          grid-template-columns: 1fr;
        }

        .quick-actions {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="dev-header">
      <h1>üß™ RSS Feed Metro Tile - Development Environment</h1>
      <p>Professional dev setup with HMR, YAML editor, grid simulator, and theme testing</p>
    </div>

    <!-- Main Container -->
    <div class="dev-container">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="config">‚öôÔ∏è Config</button>
          <button class="tab-btn" data-tab="yaml">üìù YAML</button>
          <button class="tab-btn" data-tab="advanced">üîß Advanced</button>
        </div>

        <!-- Tab Content: Config -->
        <div class="tab-content active" data-tab-content="config">
          <!-- Entity -->
          <div class="control-section">
            <h3>Entity</h3>
            <div class="control-group">
              <label>RSS Feed Entity</label>
              <select id="entity">
                <option value="sensor.die_zeit">sensor.die_zeit (10 items)</option>
                <option value="sensor.test_feed">sensor.test_feed (5 items)</option>
                <option value="sensor.empty_feed">sensor.empty_feed (Empty)</option>
                <option value="sensor.no_images">sensor.no_images (No Images)</option>
                <option value="sensor.long_titles">sensor.long_titles (Long Titles)</option>
                <option value="sensor.no_description">
                  sensor.no_description (No Description)
                </option>
                <option value="sensor.old_dates">sensor.old_dates (Old Dates)</option>
                <option value="sensor.mixed_images">sensor.mixed_images (Mixed Images)</option>
                <option value="sensor.broken_images">sensor.broken_images (Broken Images)</option>
                <option value="sensor.slow_images">sensor.slow_images (Slow Loading)</option>
                <option value="sensor.many_items">sensor.many_items (50 items)</option>
                <option value="sensor.unavailable">sensor.unavailable (Unavailable)</option>
                <option value="sensor.missing_entries">
                  sensor.missing_entries (Missing Data)
                </option>
                <option value="sensor.malformed_data">sensor.malformed_data (Malformed)</option>
              </select>
            </div>
          </div>

          <!-- Layout -->
          <div class="control-section">
            <h3>Layout</h3>
            <div class="control-group">
              <label>Aspect Ratio</label>
              <select id="aspect_ratio">
                <option value="1:1">Square (1:1)</option>
                <option value="16:9" selected>Widescreen (16:9)</option>
                <option value="4:3">Classic (4:3)</option>
              </select>
            </div>
            <div class="control-group">
              <label>Image Layout</label>
              <select id="image_layout">
                <option value="background">Background with Blur</option>
                <option value="split">Split (Image Top, Text Bottom)</option>
              </select>
            </div>
          </div>

          <!-- Carousel -->
          <div class="control-section">
            <h3>Carousel</h3>
            <div class="control-group">
              <label>Slide Duration (seconds)</label>
              <input type="number" id="slide_duration_sec" min="1" max="60" value="5" />
            </div>
            <div class="control-group">
              <label>Transition Effect</label>
              <select id="transition">
                <option value="slide-vertical">Slide Vertical</option>
                <option value="slide-horizontal">Slide Horizontal</option>
                <option value="fade">Fade</option>
              </select>
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="auto_play" checked />
                Auto Play
              </label>
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="pause_on_hover" checked />
                Pause on Hover/Touch
              </label>
            </div>
          </div>

          <!-- Content -->
          <div class="control-section">
            <h3>Content</h3>
            <div class="control-group">
              <label>Row Limit <small>(0 = all)</small></label>
              <input type="number" id="row_limit" min="0" max="100" value="10" />
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="show_images" checked />
                Show Images
              </label>
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="lazy_load_images" checked />
                Lazy Load Images
              </label>
            </div>
          </div>

          <!-- Navigation -->
          <div class="control-section">
            <h3>Navigation</h3>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="show_navigation" checked />
                Show Navigation Arrows
              </label>
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="show_indicators" checked />
                Show Indicators (Dots)
              </label>
            </div>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="keyboard_navigation" checked />
                Keyboard Navigation
              </label>
            </div>
          </div>

          <!-- Grid -->
          <div class="control-section">
            <h3>Grid (Sections View)</h3>
            <div class="control-row">
              <div class="control-group">
                <label>Grid Rows</label>
                <input type="number" id="grid_rows" min="1" max="12" value="2" />
              </div>
              <div class="control-group">
                <label>Grid Columns</label>
                <input type="number" id="grid_columns" min="1" max="12" value="6" />
              </div>
            </div>
          </div>

          <!-- Preset Loader -->
          <div class="control-section">
            <h3>Quick Presets</h3>
            <div class="control-group">
              <label>Load Preset Configuration</label>
              <select id="preset">
                <option value="">-- Select Preset --</option>
                <option value="default">Default</option>
                <option value="square">Square (1:1) - Fade</option>
                <option value="widescreen">Widescreen (16:9) - Horizontal</option>
                <option value="split">Split Layout (4:3)</option>
                <option value="noImages">No Images</option>
                <option value="empty">Empty Feed</option>
                <option value="fast">Fast Carousel (2s)</option>
                <option value="minimal">Minimal (No Controls)</option>
                <option value="longTitles">Long Titles Test</option>
                <option value="noDescription">No Description Test</option>
                <option value="oldDates">Old Dates Test</option>
                <option value="mixedImages">Mixed Images Test</option>
                <option value="brokenImages">Broken Images Test</option>
                <option value="slowImages">Slow Images Test</option>
                <option value="performance">Performance Test (50 items)</option>
                <option value="unavailable">Unavailable Entity</option>
                <option value="missingData">Missing Data</option>
                <option value="malformed">Malformed Data</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tab Content: YAML -->
        <div class="tab-content" data-tab-content="yaml">
          <div class="yaml-editor-wrapper">
            <div class="yaml-actions">
              <button onclick="formatYAML()">‚ú® Format</button>
              <button onclick="copyYAML()">üìã Copy</button>
              <button onclick="resetConfig()">üîÑ Reset</button>
            </div>
            <div id="yamlEditor"></div>
            <div class="yaml-error" id="yamlError"></div>
          </div>
        </div>

        <!-- Tab Content: Advanced -->
        <div class="tab-content" data-tab-content="advanced">
          <div class="control-section">
            <h3>Performance</h3>
            <div class="control-group">
              <label>Performance Warning Threshold</label>
              <input type="number" id="performance_warning" min="5" max="100" value="25" />
              <small style="display: block; margin-top: 4px; color: var(--secondary-text-color)">
                Show warning when feed has more items than this
              </small>
            </div>
          </div>

          <div class="control-section">
            <h3>Custom CSS</h3>
            <div class="control-group">
              <label>Custom Styles</label>
              <textarea id="style" placeholder="/* Add custom CSS here... */"></textarea>
            </div>
          </div>

          <div class="control-section">
            <h3>Developer Tools</h3>
            <div class="control-group">
              <label class="checkbox-label">
                <input type="checkbox" id="showDebugInfo" />
                Show Debug Info in Console
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <!-- View Mode Selector -->
        <div class="view-mode-selector">
          <button class="view-btn active" data-view="single">üì± Single View</button>
          <button class="view-btn" data-view="compare">‚öñÔ∏è Compare (2√ó)</button>
          <button class="view-btn" data-view="grid">‚äû Grid (2√ó2)</button>
        </div>

        <!-- Grid Controls -->
        <div class="grid-controls">
          <h3>Grid Layout Simulator</h3>
          <div class="control-row">
            <div class="control-group">
              <label>Preset Grid Size</label>
              <select id="gridPreset">
                <option value="custom">Custom...</option>
                <option value="1x1">1√ó1 (Default Tile)</option>
                <option value="2x1">2√ó1 (Wide Tile)</option>
                <option value="1x2">1√ó2 (Tall Tile)</option>
                <option value="2x2">2√ó2 (Square)</option>
                <option value="3x2">3√ó2 (Landscape)</option>
                <option value="4x2">4√ó2 (Extra Wide)</option>
                <option value="6x2" selected>6√ó2 (Full Width)</option>
                <option value="4x3">4√ó3 (Large)</option>
                <option value="6x3">6√ó3 (Extra Large)</option>
              </select>
            </div>
            <div class="control-group">
              <label>HA Theme</label>
              <select id="haTheme">
                <option value="default-light" selected>Default (Light)</option>
                <option value="default-dark">Default (Dark)</option>
                <option value="blue">Blue Theme</option>
                <option value="red">Red Theme</option>
                <option value="green">Green Theme</option>
                <option value="purple">Purple Theme</option>
                <option value="high-contrast">High Contrast</option>
              </select>
            </div>
          </div>
          <div class="grid-info">
            Current Grid: <strong id="currentGrid">6√ó2</strong> (Width:
            <span id="gridWidth">608px</span>)
          </div>
        </div>

        <!-- Preview: Single View -->
        <div class="preview-single active">
          <div class="preview-container">
            <h3>Card Preview</h3>
            <div class="card-wrapper" id="cardWrapper1"></div>
          </div>
        </div>

        <!-- Preview: Compare View -->
        <div class="preview-compare">
          <div class="preview-container">
            <h3>Main Configuration</h3>
            <div class="card-wrapper" id="cardWrapper2"></div>
          </div>
          <div class="preview-container">
            <h3>Comparison (Variant)</h3>
            <div class="card-wrapper" id="cardWrapper3"></div>
          </div>
        </div>

        <!-- Preview: Grid View (2x2) -->
        <div class="preview-grid">
          <div class="preview-container">
            <h3>Default</h3>
            <div class="card-wrapper" id="cardWrapper4"></div>
          </div>
          <div class="preview-container">
            <h3>Square (1:1)</h3>
            <div class="card-wrapper" id="cardWrapper5"></div>
          </div>
          <div class="preview-container">
            <h3>Split Layout</h3>
            <div class="card-wrapper" id="cardWrapper6"></div>
          </div>
          <div class="preview-container">
            <h3>Minimal</h3>
            <div class="card-wrapper" id="cardWrapper7"></div>
          </div>
        </div>

        <!-- Config Status -->
        <div class="config-status">
          <div><strong>Entity:</strong> <span id="statusEntity">sensor.die_zeit</span></div>
          <div>
            <strong>Layout:</strong> <span id="statusLayout">6√ó2 Grid, Background layout</span>
          </div>
          <div>
            <strong>Carousel:</strong>
            <span id="statusCarousel">5s slide-vertical, auto-play ON</span>
          </div>
          <div>
            <strong>Navigation:</strong>
            <span id="statusNavigation">Arrows ‚úì, Dots ‚úì, Keyboard ‚úì</span>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button onclick="copyYAML()">üìã Copy YAML</button>
          <button onclick="resetConfig()">üîÑ Reset Config</button>
          <button onclick="shareConfig()">üîó Share (URL)</button>
          <button onclick="exportConfig()">üíæ Export JSON</button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Scripts -->
    <script type="module">
      // Import dependencies
      import {
        generateMockFeedItems,
        createMockHass,
        presetConfigs,
        HA_THEMES,
        GRID_PRESETS,
      } from './mock-data.ts';
      import { EditorView, basicSetup } from 'https://esm.sh/codemirror@6.0.1';
      import { yaml } from 'https://esm.sh/@codemirror/lang-yaml@6.1.1';
      import jsyaml from 'https://esm.sh/js-yaml@4.1.0';

      // Import the built card component
      import '../dist/rssfeed-metro-tile.js';

      // Global State
      let mockHass;
      let configState = {
        entity: 'sensor.die_zeit',
        slide_duration_sec: 5,
        row_limit: 10,
      };
      let yamlEditor;
      let isUpdatingYAML = false;
      let isUpdatingConfig = false;

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        initializeMockData();
        initializeControls();
        initializeYAMLEditor();
        initializeTabs();
        initializeViewModes();
        initializeThemes();
        loadFromURL();
        createCards();
        updateStatusDisplay();
      });

      // Initialize Mock Data
      function initializeMockData() {
        const feedCount = 10;
        const feedItems = generateMockFeedItems(feedCount);
        mockHass = createMockHass(feedItems);
      }

      // Initialize Controls
      function initializeControls() {
        // Get all config inputs
        const inputs = [
          'entity',
          'aspect_ratio',
          'image_layout',
          'slide_duration_sec',
          'transition',
          'auto_play',
          'pause_on_hover',
          'row_limit',
          'show_images',
          'lazy_load_images',
          'show_navigation',
          'show_indicators',
          'keyboard_navigation',
          'grid_rows',
          'grid_columns',
          'performance_warning',
          'style',
        ];

        inputs.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;

          if (el.type === 'checkbox') {
            el.addEventListener('change', () => updateConfigFromControls(id, el.checked));
          } else if (el.type === 'number') {
            el.addEventListener('input', () => updateConfigFromControls(id, parseInt(el.value)));
          } else {
            el.addEventListener('change', () => updateConfigFromControls(id, el.value));
          }
        });

        // Preset selector
        document.getElementById('preset').addEventListener('change', e => {
          if (e.target.value) {
            loadPreset(e.target.value);
          }
        });

        // Grid preset selector
        document.getElementById('gridPreset').addEventListener('change', e => {
          applyGridPreset(e.target.value);
        });

        // Aspect ratio show/hide tile height
        document.getElementById('aspect_ratio').addEventListener('change', e => {
          const tileHeightGroup = document.getElementById('tileHeightGroup');
          tileHeightGroup.style.display = e.target.value ? 'none' : 'block';
        });
      }

      // Initialize YAML Editor
      function initializeYAMLEditor() {
        yamlEditor = new EditorView({
          doc: configToYAML(configState),
          extensions: [
            basicSetup,
            yaml(),
            EditorView.updateListener.of(update => {
              if (update.docChanged && !isUpdatingYAML) {
                onYAMLChange();
              }
            }),
          ],
          parent: document.getElementById('yamlEditor'),
        });
      }

      // Initialize Tabs
      function initializeTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;

            // Update buttons
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update content
            tabContents.forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab-content="${tab}"]`).classList.add('active');
          });
        });
      }

      // Initialize View Modes
      function initializeViewModes() {
        const viewBtns = document.querySelectorAll('.view-btn');
        const previews = [
          document.querySelector('.preview-single'),
          document.querySelector('.preview-compare'),
          document.querySelector('.preview-grid'),
        ];

        viewBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;

            // Update buttons
            viewBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update previews
            previews.forEach(p => p.classList.remove('active'));
            document.querySelector(`.preview-${view}`).classList.add('active');

            // Create cards if needed
            if (view === 'compare') {
              createCard('cardWrapper2', configState);
              createCard('cardWrapper3', {
                ...configState,
                aspect_ratio: '1:1',
                transition: 'fade',
              });
            } else if (view === 'grid') {
              createCard('cardWrapper4', configState);
              createCard('cardWrapper5', {
                ...configState,
                aspect_ratio: '1:1',
                transition: 'fade',
              });
              createCard('cardWrapper6', {
                ...configState,
                aspect_ratio: '4:3',
                image_layout: 'split',
              });
              createCard('cardWrapper7', {
                ...configState,
                show_navigation: false,
                show_indicators: false,
              });
            }
          });
        });
      }

      // Initialize Themes
      function initializeThemes() {
        document.getElementById('haTheme').addEventListener('change', e => {
          applyTheme(e.target.value);
        });
      }

      // Apply Theme
      function applyTheme(themeName) {
        const theme = HA_THEMES[themeName];
        if (!theme) return;

        const root = document.documentElement;
        Object.entries(theme).forEach(([property, value]) => {
          root.style.setProperty(property, value);
        });

        // Update body class for dev UI
        document.body.className = themeName.includes('dark') ? 'dark' : '';

        showToast('Theme applied: ' + themeName, 'success');
      }

      // Apply Grid Preset
      function applyGridPreset(presetName) {
        if (presetName === 'custom') return;

        const preset = GRID_PRESETS[presetName];
        if (!preset) return;

        const { columns, rows } = preset;
        const GRID_COLUMN_WIDTH = 100;
        const GRID_ROW_HEIGHT = 100;
        const GRID_GAP = 8;

        const width = columns * GRID_COLUMN_WIDTH + (columns - 1) * GRID_GAP;

        // Update all card wrappers
        document.querySelectorAll('.card-wrapper').forEach(wrapper => {
          wrapper.style.width = `${width}px`;
        });

        // Update grid info
        document.getElementById('currentGrid').textContent = `${columns}√ó${rows}`;
        document.getElementById('gridWidth').textContent = `${width}px`;

        // Update config
        updateConfigFromControls('grid_columns', columns);
        updateConfigFromControls('grid_rows', rows);
      }

      // Update Config from Controls
      function updateConfigFromControls(key, value) {
        if (isUpdatingConfig) return;
        isUpdatingConfig = true;

        // Update config state
        if (value === '' || value === undefined) {
          delete configState[key];
        } else {
          configState[key] = value;
        }

        // Update cards
        updateCards();

        // Update YAML editor
        updateYAMLEditor();

        // Update status
        updateStatusDisplay();

        isUpdatingConfig = false;
      }

      // Update YAML Editor
      function updateYAMLEditor() {
        if (isUpdatingYAML) return;
        isUpdatingYAML = true;

        const yamlStr = configToYAML(configState);
        yamlEditor.dispatch({
          changes: {
            from: 0,
            to: yamlEditor.state.doc.length,
            insert: yamlStr,
          },
        });

        isUpdatingYAML = false;
      }

      // On YAML Change
      function onYAMLChange() {
        if (isUpdatingConfig) return;
        isUpdatingConfig = true;

        const yamlStr = yamlEditor.state.doc.toString();

        try {
          const newConfig = jsyaml.load(yamlStr);

          // Hide error
          document.getElementById('yamlError').classList.remove('show');

          // Update config state
          Object.assign(configState, newConfig);

          // Update visual controls
          updateVisualControls();

          // Update cards
          updateCards();

          // Update status
          updateStatusDisplay();
        } catch (e) {
          // Show error
          const errorEl = document.getElementById('yamlError');
          errorEl.textContent = 'YAML Error: ' + e.message;
          errorEl.classList.add('show');
        }

        isUpdatingConfig = false;
      }

      // Update Visual Controls from Config
      function updateVisualControls() {
        Object.entries(configState).forEach(([key, value]) => {
          const el = document.getElementById(key);
          if (!el) return;

          if (el.type === 'checkbox') {
            el.checked = value !== false;
          } else {
            el.value = value;
          }
        });
      }

      // Config to YAML
      function configToYAML(config) {
        return jsyaml.dump(config, {
          indent: 2,
          lineWidth: 80,
          noRefs: true,
        });
      }

      // Load Preset
      function loadPreset(presetName) {
        const preset = presetConfigs[presetName];
        if (!preset) return;

        // Update config state
        configState = { ...preset };

        // Update visual controls
        updateVisualControls();

        // Update YAML editor
        updateYAMLEditor();

        // Update cards
        updateCards();

        // Update status
        updateStatusDisplay();

        showToast('Preset loaded: ' + presetName, 'success');
      }

      // Create Cards
      function createCards() {
        createCard('cardWrapper1', configState);
      }

      // Create Card
      function createCard(wrapperId, config) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;

        wrapper.innerHTML = '';

        const card = document.createElement('rssfeed-metro-tile');
        card.hass = mockHass;
        card.setConfig(config);

        wrapper.appendChild(card);
      }

      // Update Cards
      function updateCards() {
        // Update main card
        const card1 = document.querySelector('#cardWrapper1 rssfeed-metro-tile');
        if (card1) {
          card1.setConfig(configState);
          card1.hass = mockHass;
        }

        // Update compare view if active
        const card2 = document.querySelector('#cardWrapper2 rssfeed-metro-tile');
        if (card2) {
          card2.setConfig(configState);
          card2.hass = mockHass;
        }

        // Update grid view if active
        const card4 = document.querySelector('#cardWrapper4 rssfeed-metro-tile');
        if (card4) {
          card4.setConfig(configState);
          card4.hass = mockHass;
        }
      }

      // Update Status Display
      function updateStatusDisplay() {
        const {
          entity,
          grid_columns,
          grid_rows,
          image_layout,
          slide_duration_sec,
          transition,
          auto_play,
          show_navigation,
          show_indicators,
          keyboard_navigation,
        } = configState;

        document.getElementById('statusEntity').textContent = entity || 'sensor.die_zeit';
        document.getElementById('statusLayout').textContent =
          `${grid_columns || 6}√ó${grid_rows || 2} Grid, ${image_layout || 'background'} layout`;
        document.getElementById('statusCarousel').textContent =
          `${slide_duration_sec || 5}s ${transition || 'slide-vertical'}, auto-play ${auto_play !== false ? 'ON' : 'OFF'}`;

        const navParts = [];
        if (show_navigation !== false) navParts.push('Arrows ‚úì');
        if (show_indicators !== false) navParts.push('Dots ‚úì');
        if (keyboard_navigation !== false) navParts.push('Keyboard ‚úì');
        document.getElementById('statusNavigation').textContent = navParts.join(', ') || 'None';
      }

      // Global Functions
      window.formatYAML = () => {
        updateYAMLEditor();
        showToast('YAML formatted', 'success');
      };

      window.copyYAML = () => {
        const yamlStr = yamlEditor.state.doc.toString();
        navigator.clipboard.writeText(yamlStr).then(() => {
          showToast('YAML copied to clipboard', 'success');
        });
      };

      window.resetConfig = () => {
        configState = { ...presetConfigs.default };
        updateVisualControls();
        updateYAMLEditor();
        updateCards();
        updateStatusDisplay();
        showToast('Config reset to default', 'success');
      };

      window.shareConfig = () => {
        const encoded = btoa(JSON.stringify(configState));
        const url = `${window.location.origin}${window.location.pathname}?config=${encoded}`;
        navigator.clipboard.writeText(url).then(() => {
          showToast('Share URL copied to clipboard', 'success');
        });
      };

      window.exportConfig = () => {
        const json = JSON.stringify(configState, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'rssfeed-metro-tile-config.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Config exported as JSON', 'success');
      };

      // Load from URL
      function loadFromURL() {
        const params = new URLSearchParams(location.search);
        if (params.has('config')) {
          try {
            const config = JSON.parse(atob(params.get('config')));
            configState = config;
            updateVisualControls();
            updateYAMLEditor();
            showToast('Config loaded from URL', 'success');
          } catch (e) {
            console.error('Invalid config in URL', e);
          }
        }
      }

      // Show Toast
      function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');

        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
    </script>
  </body>
</html>
