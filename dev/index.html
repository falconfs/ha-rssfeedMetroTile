<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RSS Feed Metro Tile - Dev Environment</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: var(--dev-bg, #f5f5f5);
        color: var(--dev-text, #333);
        overflow-x: hidden;
      }

      /* =========================
         CSS Variables (Light/Dark)
         ========================= */
      :root {
        --dev-bg: #f5f5f5;
        --dev-text: #333;
        --dev-panel-bg: #ffffff;
        --dev-border: #e0e0e0;
        --dev-input-bg: #ffffff;
        --dev-input-border: #ddd;
        --dev-button-bg: #f5f5f5;
        --dev-button-hover: #e0e0e0;
        --dev-tab-active: #2196f3;
        --dev-shadow: rgba(0, 0, 0, 0.1);

        /* HA Theme Variables (Default Light) */
        --ha-card-background: #ffffff;
        --card-background-color: #ffffff;
        --primary-text-color: #212121;
        --secondary-text-color: #727272;
        --primary-color: #03a9f4;
        --accent-color: #ff9800;
        --secondary-background-color: #f5f5f5;
        --divider-color: rgba(0, 0, 0, 0.12);
        --error-color: #db4437;
        --warning-color: #ffa500;
      }

      body.dark {
        --dev-bg: #1a1a1a;
        --dev-text: #e0e0e0;
        --dev-panel-bg: #2d2d2d;
        --dev-border: #444;
        --dev-input-bg: #1a1a1a;
        --dev-input-border: #444;
        --dev-button-bg: #1a1a1a;
        --dev-button-hover: #333;
        --dev-shadow: rgba(0, 0, 0, 0.3);
      }

      /* =========================
         Header
         ========================= */
      .dev-header {
        background: var(--dev-panel-bg);
        padding: 16px 24px;
        border-bottom: 1px solid var(--dev-border);
        box-shadow: 0 2px 4px var(--dev-shadow);
      }

      .dev-header h1 {
        font-size: 20px;
        margin-bottom: 4px;
        color: var(--dev-text);
      }

      .dev-header p {
        font-size: 13px;
        color: var(--secondary-text-color);
      }

      /* =========================
         Main Layout (Split View)
         ========================= */
      .dev-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        height: calc(100vh - 70px);
        gap: 0;
      }

      /* Left Panel */
      .left-panel {
        background: var(--dev-panel-bg);
        border-right: 1px solid var(--dev-border);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      /* Tabs */
      .tabs {
        display: flex;
        border-bottom: 1px solid var(--dev-border);
        background: var(--dev-panel-bg);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .tab-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: var(--dev-text);
        cursor: pointer;
        font-size: 13px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        background: var(--dev-button-hover);
      }

      .tab-btn.active {
        border-bottom-color: var(--dev-tab-active);
        color: var(--dev-tab-active);
      }

      /* Tab Content */
      .tab-content {
        display: none;
        padding: 16px;
        flex: 1;
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }

      /* Control Section */
      .control-section {
        margin-bottom: 24px;
      }

      .control-section h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--dev-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .control-group {
        margin-bottom: 16px;
      }

      .control-group label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
        color: var(--dev-text);
      }

      .control-group small {
        color: var(--secondary-text-color);
        font-size: 11px;
      }

      .control-group input[type='text'],
      .control-group input[type='number'],
      .control-group select,
      .control-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--dev-input-border);
        border-radius: 4px;
        background: var(--dev-input-bg);
        color: var(--dev-text);
        font-size: 13px;
      }

      .control-group textarea {
        font-family: 'Courier New', monospace;
        resize: vertical;
      }

      .control-group input[type='checkbox'] {
        margin-right: 8px;
      }

      /* YAML Editor */
      #yamlEditor {
        height: calc(100vh - 220px);
        border: 1px solid var(--dev-border);
        border-radius: 4px;
        overflow: auto;
      }

      /* Right Panel */
      .right-panel {
        background: var(--dev-bg);
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Preview Header */
      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .view-modes {
        display: flex;
        gap: 8px;
      }

      .view-btn {
        padding: 8px 16px;
        border: 1px solid var(--dev-border);
        background: var(--dev-button-bg);
        color: var(--dev-text);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .view-btn:hover {
        background: var(--dev-button-hover);
      }

      .view-btn.active {
        background: var(--dev-tab-active);
        color: white;
        border-color: var(--dev-tab-active);
      }

      /* Grid Controls */
      .grid-controls {
        background: var(--dev-panel-bg);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--dev-border);
      }

      .grid-controls h3 {
        font-size: 14px;
        margin-bottom: 12px;
      }

      .grid-controls-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .grid-info {
        margin-top: 12px;
        font-size: 12px;
        color: var(--secondary-text-color);
      }

      /* Preview Container */
      .preview-container {
        background: var(--dev-panel-bg);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--dev-border);
      }

      .preview-container h3 {
        font-size: 13px;
        margin-bottom: 12px;
        color: var(--secondary-text-color);
      }

      .card-wrapper {
        min-height: 200px;
      }

      /* Preview Views */
      .preview-single,
      .preview-compare,
      .preview-grid {
        display: none;
      }

      .preview-single.active {
        display: block;
      }

      .preview-compare.active,
      .preview-grid.active {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Config Status */
      .config-status {
        background: var(--dev-panel-bg);
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--dev-border);
        margin-top: 16px;
        font-size: 12px;
        line-height: 1.8;
      }

      .config-status strong {
        color: var(--dev-text);
      }

      .config-status span {
        color: var(--secondary-text-color);
      }

      /* Quick Actions */
      .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 16px;
      }

      .quick-actions button {
        padding: 10px 16px;
        border: 1px solid var(--dev-border);
        background: var(--dev-button-bg);
        color: var(--dev-text);
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      .quick-actions button:hover {
        background: var(--dev-button-hover);
        transform: translateY(-1px);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        background: #323232;
        color: white;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s;
        pointer-events: none;
        z-index: 1000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .dev-container {
          grid-template-columns: 1fr;
        }

        .left-panel {
          height: 50vh;
        }

        .preview-compare.active,
        .preview-grid.active {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="dev-header">
      <h1>üß™ RSS Feed Metro Tile - Development Environment (Dynamic Config)</h1>
      <p>‚ú® Automatically generated UI controls from TypeScript types</p>
    </div>

    <!-- Main Container -->
    <div class="dev-container">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="config">‚öôÔ∏è Config</button>
          <button class="tab-btn" data-tab="yaml">üìù YAML</button>
          <button class="tab-btn" data-tab="info">‚ÑπÔ∏è Info</button>
        </div>

        <!-- Tab Content: Config -->
        <div class="tab-content active" data-tab-content="config">
          <!-- Preset Selector -->
          <div class="control-section">
            <h3>Quick Start</h3>
            <div class="control-group">
              <label>Load Preset</label>
              <select id="presetSelector">
                <option value="">Select Preset...</option>
              </select>
            </div>
          </div>

          <!-- DYNAMIC CONTROLS INJECTED HERE -->
          <div id="dynamicControls"></div>
        </div>

        <!-- Tab Content: YAML -->
        <div class="tab-content" data-tab-content="yaml">
          <div class="control-section">
            <h3>YAML Editor</h3>
            <p style="font-size: 12px; color: var(--secondary-text-color); margin-bottom: 12px">
              Edit YAML directly or use the visual controls. Changes sync both ways.
            </p>
            <div id="yamlEditor"></div>
          </div>
        </div>

        <!-- Tab Content: Info -->
        <div class="tab-content" data-tab-content="info">
          <div class="control-section">
            <h3>About Dynamic Config System</h3>
            <p style="font-size: 13px; line-height: 1.6; margin-bottom: 12px">
              This dev environment uses <strong>automatic UI generation</strong> from TypeScript
              types.
            </p>
            <ul style="font-size: 12px; line-height: 1.8; padding-left: 20px">
              <li>‚úÖ Controls generated from <code>config-generator.ts</code></li>
              <li>‚úÖ Always in sync with source code</li>
              <li>‚úÖ Automatic dependency management</li>
              <li>‚úÖ No manual HTML needed</li>
            </ul>
            <p style="font-size: 12px; margin-top: 16px">
              <strong>See:</strong>
              <a href="DYNAMIC_CONFIG.md" target="_blank">DYNAMIC_CONFIG.md</a> for documentation
            </p>
          </div>

          <div class="control-section">
            <h3>System Info</h3>
            <div style="font-size: 12px; line-height: 1.8">
              <div><strong>Total Controls:</strong> <span id="totalControls">0</span></div>
              <div><strong>Categories:</strong> <span id="totalCategories">0</span></div>
              <div><strong>Version:</strong> 2.1.0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <!-- Preview Header -->
        <div class="preview-header">
          <h2 style="font-size: 16px">Live Preview</h2>
          <div class="view-modes">
            <button class="view-btn active" data-view="single">Single</button>
            <button class="view-btn" data-view="compare">Compare</button>
            <button class="view-btn" data-view="grid">Grid (2x2)</button>
          </div>
        </div>

        <!-- Grid Controls -->
        <div class="grid-controls">
          <h3>Grid Simulator</h3>
          <div class="grid-controls-row">
            <div class="control-group">
              <label>Grid Size</label>
              <select id="gridPreset">
                <option value="4x2">4√ó2 (Mobile)</option>
                <option value="6x2" selected>6√ó2 (Tablet)</option>
                <option value="8x2">8√ó2 (Desktop)</option>
                <option value="12x2">12√ó2 (Large)</option>
              </select>
            </div>
            <div class="control-group">
              <label>Theme</label>
              <select id="haTheme">
                <option value="default-light" selected>Light</option>
                <option value="default-dark">Dark</option>
              </select>
            </div>
          </div>
          <div class="grid-info">
            Current Grid: <strong id="currentGrid">6√ó2</strong>
          </div>
        </div>

        <!-- Preview: Single View -->
        <div class="preview-single active">
          <div class="preview-container">
            <h3>Card Preview</h3>
            <div class="card-wrapper" id="cardWrapper1"></div>
          </div>
        </div>

        <!-- Preview: Compare View -->
        <div class="preview-compare">
          <div class="preview-container">
            <h3>Main Configuration</h3>
            <div class="card-wrapper" id="cardWrapper2"></div>
          </div>
          <div class="preview-container">
            <h3>Variant</h3>
            <div class="card-wrapper" id="cardWrapper3"></div>
          </div>
        </div>

        <!-- Preview: Grid View (2x2) -->
        <div class="preview-grid">
          <div class="preview-container">
            <h3>Default</h3>
            <div class="card-wrapper" id="cardWrapper4"></div>
          </div>
          <div class="preview-container">
            <h3>Square (1:1)</h3>
            <div class="card-wrapper" id="cardWrapper5"></div>
          </div>
          <div class="preview-container">
            <h3>Split Layout</h3>
            <div class="card-wrapper" id="cardWrapper6"></div>
          </div>
          <div class="preview-container">
            <h3>Minimal</h3>
            <div class="card-wrapper" id="cardWrapper7"></div>
          </div>
        </div>

        <!-- Config Status -->
        <div class="config-status">
          <div><strong>Entity:</strong> <span id="statusEntity">sensor.die_zeit</span></div>
          <div><strong>Layout:</strong> <span id="statusLayout">6√ó2 Grid</span></div>
          <div><strong>Carousel:</strong> <span id="statusCarousel">5s slide-vertical</span></div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button onclick="copyYAML()">üìã Copy YAML</button>
          <button onclick="resetConfig()">üîÑ Reset</button>
          <button onclick="shareConfig()">üîó Share URL</button>
          <button onclick="exportConfig()">üíæ Export JSON</button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Scripts -->
    <script type="module">
      // Import dependencies
      import { generateMockFeedItems, createMockHass, HA_THEMES, GRID_PRESETS } from './mock-data.ts';
      import { 
        initializeDynamicUI, 
        updateControlValues, 
        getControlValues,
        loadPreset,
        getPresetOptions,
        getAllControlIds,
        CATEGORY_LABELS
      } from './ui-generator.ts';
      import { DEFAULT_CONFIG } from '../src/constants.ts';
      import { EditorView, basicSetup } from 'https://esm.sh/codemirror@6.0.1';
      import { yaml } from 'https://esm.sh/@codemirror/lang-yaml@6.1.1';
      import jsyaml from 'https://esm.sh/js-yaml@4.1.0';

      // Import the built card component
      import '../dist/rssfeed-metro-tile.js';

      // Global State
      let mockHass;
      let configState = { ...DEFAULT_CONFIG, entity: 'sensor.die_zeit' };
      let yamlEditor;
      let isUpdatingYAML = false;
      let isUpdatingConfig = false;

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Initializing dev environment with dynamic config system...');
        
        initializeMockData();
        initializeDynamicControls();
        initializePresetSelector();
        initializeYAMLEditor();
        initializeTabs();
        initializeViewModes();
        initializeThemes();
        initializeGridSimulator();
        updateSystemInfo();
        createCards();
        updateStatusDisplay();
        
        console.log('‚úÖ Dev environment ready!');
      });

      // Initialize Mock Data
      function initializeMockData() {
        const feedItems = generateMockFeedItems(10);
        mockHass = createMockHass(feedItems);
      }

      // Initialize Dynamic Controls - THIS IS THE MAGIC! ‚ú®
      function initializeDynamicControls() {
        console.log('üìù Injecting dynamic controls...');
        
        initializeDynamicUI({
          containerId: 'dynamicControls',
          initialConfig: configState,
          onConfigChange: (newConfig) => {
            if (!isUpdatingConfig) {
              isUpdatingConfig = true;
              configState = newConfig;
              createCards();
              updateStatusDisplay();
              updateYAMLFromConfig();
              isUpdatingConfig = false;
            }
          }
        });
        
        console.log('‚úÖ Dynamic controls injected!');
      }

      // Initialize Preset Selector
      function initializePresetSelector() {
        const select = document.getElementById('presetSelector');
        getPresetOptions().forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
          if (e.target.value) {
            const presetConfig = loadPreset(e.target.value);
            if (presetConfig) {
              configState = { ...configState, ...presetConfig };
              updateControlValues(configState);
              createCards();
              updateStatusDisplay();
              updateYAMLFromConfig();
              showToast('Preset loaded: ' + e.target.value);
            }
          }
        });
      }

      // Initialize YAML Editor
      function initializeYAMLEditor() {
        yamlEditor = new EditorView({
          doc: configToYAML(configState),
          extensions: [
            basicSetup,
            yaml(),
            EditorView.updateListener.of(update => {
              if (update.docChanged && !isUpdatingYAML) {
                onYAMLChange();
              }
            }),
          ],
          parent: document.getElementById('yamlEditor'),
        });
      }

      function configToYAML(config) {
        const filtered = {};
        Object.keys(config).forEach(key => {
          if (config[key] !== undefined && config[key] !== '') {
            filtered[key] = config[key];
          }
        });
        return jsyaml.dump({ type: 'custom:rssfeed-metro-tile', ...filtered }, { indent: 2 });
      }

      function updateYAMLFromConfig() {
        if (!yamlEditor || isUpdatingYAML) return;
        isUpdatingYAML = true;
        const yaml = configToYAML(configState);
        yamlEditor.dispatch({
          changes: { from: 0, to: yamlEditor.state.doc.length, insert: yaml }
        });
        isUpdatingYAML = false;
      }

      function onYAMLChange() {
        try {
          const text = yamlEditor.state.doc.toString();
          const parsed = jsyaml.load(text);
          if (parsed && typeof parsed === 'object') {
            const { type, ...config } = parsed;
            configState = { ...DEFAULT_CONFIG, ...config };
            updateControlValues(configState);
            createCards();
            updateStatusDisplay();
          }
        } catch (err) {
          console.warn('YAML parse error:', err);
        }
      }

      // Initialize Tabs
      function initializeTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tabContents.forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab-content="${tab}"]`).classList.add('active');
          });
        });
      }

      // Initialize View Modes
      function initializeViewModes() {
        const viewBtns = document.querySelectorAll('.view-btn');
        const previews = [
          document.querySelector('.preview-single'),
          document.querySelector('.preview-compare'),
          document.querySelector('.preview-grid'),
        ];

        viewBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            viewBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            previews.forEach(p => p.classList.remove('active'));
            document.querySelector(`.preview-${view}`).classList.add('active');

            if (view === 'compare') {
              createCard('cardWrapper2', configState);
              createCard('cardWrapper3', { ...configState, aspect_ratio: '1:1', transition: 'fade' });
            } else if (view === 'grid') {
              createCard('cardWrapper4', configState);
              createCard('cardWrapper5', { ...configState, aspect_ratio: '1:1' });
              createCard('cardWrapper6', { ...configState, image_layout: 'split' });
              createCard('cardWrapper7', { ...configState, show_navigation: false, show_indicators: false });
            }
          });
        });
      }

      // Initialize Themes
      function initializeThemes() {
        document.getElementById('haTheme').addEventListener('change', (e) => {
          const theme = HA_THEMES[e.target.value] || HA_THEMES['default-light'];
          Object.entries(theme).forEach(([key, value]) => {
            document.documentElement.style.setProperty(key, value);
          });
        });
      }

      // Initialize Grid Simulator
      function initializeGridSimulator() {
        document.getElementById('gridPreset').addEventListener('change', (e) => {
          const preset = GRID_PRESETS[e.target.value];
          if (preset) {
            document.getElementById('currentGrid').textContent = preset.label;
            // Apply grid width simulation here if needed
          }
        });
      }

      // Update System Info
      function updateSystemInfo() {
        document.getElementById('totalControls').textContent = getAllControlIds().length;
        document.getElementById('totalCategories').textContent = Object.keys(CATEGORY_LABELS).length;
      }

      // Create Cards
      function createCards() {
        createCard('cardWrapper1', configState);
      }

      function createCard(wrapperId, config) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;

        wrapper.innerHTML = '';
        const card = document.createElement('rssfeed-metro-tile');
        card.hass = mockHass;
        card.setConfig({ type: 'custom:rssfeed-metro-tile', ...config });
        wrapper.appendChild(card);
      }

      // Update Status Display
      function updateStatusDisplay() {
        document.getElementById('statusEntity').textContent = configState.entity || 'None';
        document.getElementById('statusLayout').textContent = 
          `${configState.grid_columns || 6}√ó${configState.grid_rows || 2} Grid, ${configState.aspect_ratio || 'dynamic'} ratio`;
        document.getElementById('statusCarousel').textContent = 
          `${configState.slide_duration_sec || 5}s ${configState.transition || 'slide-vertical'}`;
      }

      // Utility Functions
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      // Global functions for buttons
      window.copyYAML = function() {
        const yaml = configToYAML(configState);
        navigator.clipboard.writeText(yaml);
        showToast('‚úÖ YAML copied to clipboard!');
      };

      window.resetConfig = function() {
        configState = { ...DEFAULT_CONFIG, entity: 'sensor.die_zeit' };
        updateControlValues(configState);
        createCards();
        updateStatusDisplay();
        updateYAMLFromConfig();
        showToast('üîÑ Config reset to defaults');
      };

      window.shareConfig = function() {
        const url = new URL(window.location);
        url.searchParams.set('config', btoa(JSON.stringify(configState)));
        navigator.clipboard.writeText(url.toString());
        showToast('üîó Share URL copied!');
      };

      window.exportConfig = function() {
        const json = JSON.stringify(configState, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'rssfeed-config.json';
        a.click();
        showToast('üíæ Config exported!');
      };
    </script>
  </body>
</html>
